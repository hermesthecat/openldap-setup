Alma Linux 8 OpenLDAP Server Kurulumu

OS: Alma Linux 8.6
ip: 192.168.205.3
hostname: ldapmaster.hermes.local
domain: hermes.local
tüm şifreler: azadazad
azadazad SSHA'lı hali: {SSHA}2jEeYRSHerfUNztuwVDHnQtDSKrMKrXz
test kullanıcıları: kerem ve abdullah

    CN – Common Name
    O – Organizational
    OU – Organizational Unit
    SN – Last Name
    DC – Domain Component(DC often comes with two entries dc=example,dc=com)
    DN – Distinguished Name

güncellemelerden önce key güncelleme:
rpm --import https://repo.almalinux.org/almalinux/RPM-GPG-KEY-AlmaLinux

temel paketleri yükleme: 
yum install nano wget -y

tüm güncellemeleri yapalım:
sudo dnf update -y

reboot gerekirse yapılsın:
[ -f /var/run/reboot-required ] && sudo reboot -f

hostname'i ayarlayalım:
sudo hostnamectl set-hostname ldapmaster.hermes.local

hosts dosyasını güncelleyelim:
sudo echo "192.168.205.3 ldapmaster.hermes.local" >> /etc/hosts
sudo echo "192.168.205.4 ldapclient.hermes.local" >> /etc/hosts

cat /etc/hosts

openldap paketleri için repo ekleme:
sudo wget -q https://repo.symas.com/configs/SOFL/rhel8/sofl.repo -O /etc/yum.repos.d/sofl.repo

paketlerin kurulumu:
sudo dnf install symas-openldap-clients symas-openldap-servers -y

harbiden kuruldu mu:
rpm -qa | grep ldap

SLAPD veritabanı ayarlamaları:
sudo cp /usr/share/openldap-servers/DB_CONFIG.example /var/lib/ldap/DB_CONFIG 
sudo chown ldap. /var/lib/ldap/DB_CONFIG 
sudo systemctl enable --now slapd

slapd çalışıyor değil mi:
systemctl status slapd

firewalla kuralları ekleyelim:
sudo firewall-cmd --add-service={ldap,ldaps} --permanent
sudo firewall-cmd --reload

ldap için admin şifresi oluşturma:
slappasswd
(ikiz kez aynı şifreyi yaz enter'la)
çıkan yazıyı kopyala ben örnek olarak
azadazad = {SSHA}2jEeYRSHerfUNztuwVDHnQtDSKrMKrXz
kullancam

root şifre güncelleme dosyası oluşturalım:
nano /root/changerootpw.ldif

dn: olcDatabase={0}config,cn=config
changetype: modify
add: olcRootPW
olcRootPW: {SSHA}2jEeYRSHerfUNztuwVDHnQtDSKrMKrXz

kaydet.

şifreyi güncelleyelim:
sudo ldapadd -Y EXTERNAL -H ldapi:/// -f /root/changerootpw.ldif

şema dosyalarının import edilmesi:
sudo ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/schema/cosine.ldif
sudo ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/schema/nis.ldif 
sudo ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/schema/inetorgperson.ldif

sudo için şema ayarlaması: 
sudo cp /usr/share/doc/sudo/schema.OpenLDAP  /etc/openldap/schema/sudo.schema

sudo için şema ldif dosyası oluşturalım:
sudo tee  /etc/openldap/schema/sudo.ldif<<EOF
dn: cn=sudo,cn=schema,cn=config
objectClass: olcSchemaConfig
cn: sudo
olcAttributeTypes: ( 1.3.6.1.4.1.15953.9.1.1 NAME 'sudoUser' DESC 'User(s) who may  run sudo' EQUALITY caseExactIA5Match SUBSTR caseExactIA5SubstringsMatch SYNTAX 1.3.6.1.4.1.1466.115.121.1.26 )
olcAttributeTypes: ( 1.3.6.1.4.1.15953.9.1.2 NAME 'sudoHost' DESC 'Host(s) who may run sudo' EQUALITY caseExactIA5Match SUBSTR caseExactIA5SubstringsMatch SYNTAX 1.3.6.1.4.1.1466.115.121.1.26 )
olcAttributeTypes: ( 1.3.6.1.4.1.15953.9.1.3 NAME 'sudoCommand' DESC 'Command(s) to be executed by sudo' EQUALITY caseExactIA5Match SYNTAX 1.3.6.1.4.1.1466.115.121.1.26 )
olcAttributeTypes: ( 1.3.6.1.4.1.15953.9.1.4 NAME 'sudoRunAs' DESC 'User(s) impersonated by sudo (deprecated)' EQUALITY caseExactIA5Match SYNTAX 1.3.6.1.4.1.1466.115.121.1.26 )
olcAttributeTypes: ( 1.3.6.1.4.1.15953.9.1.5 NAME 'sudoOption' DESC 'Options(s) followed by sudo' EQUALITY caseExactIA5Match SYNTAX 1.3.6.1.4.1.1466.115.121.1.26 )
olcAttributeTypes: ( 1.3.6.1.4.1.15953.9.1.6 NAME 'sudoRunAsUser' DESC 'User(s) impersonated by sudo' EQUALITY caseExactIA5Match SYNTAX 1.3.6.1.4.1.1466.115.121.1.26 )
olcAttributeTypes: ( 1.3.6.1.4.1.15953.9.1.7 NAME 'sudoRunAsGroup' DESC 'Group(s) impersonated by sudo' EQUALITY caseExactIA5Match SYNTAX 1.3.6.1.4.1.1466.115.121.1.26 )
olcObjectClasses: ( 1.3.6.1.4.1.15953.9.2.1 NAME 'sudoRole' SUP top STRUCTURAL DESC 'Sudoer Entries' MUST ( cn ) MAY ( sudoUser $ sudoHost $ sudoCommand $ sudoRunAs $ sudoRunAsUser $ sudoRunAsGroup $ sudoOption $ description ) )
EOF

sudo şemasını uygulayalım:
sudo ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/schema/sudo.ldif

ldap veritabanı için domain adımı güncelleyelim:
sudo nano /root/setdomainname.ldif

dn: olcDatabase={2}mdb,cn=config
changetype: modify
replace: olcSuffix
olcSuffix: dc=hermes,dc=local

dn: olcDatabase={2}mdb,cn=config
changetype: modify
replace: olcRootDN
olcRootDN: cn=Manager,dc=hermes,dc=local

dn: olcDatabase={2}mdb,cn=config
changetype: modify
replace: olcRootPW
olcRootPW: {SSHA}2jEeYRSHerfUNztuwVDHnQtDSKrMKrXz

dn: olcDatabase={1}monitor,cn=config
changetype: modify
replace: olcAccess
olcAccess: {0}to * by dn.base="gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth"
  read by dn.base="cn=Manager,dc=hermes,dc=local" read by * none
  
dosyayı kaydet.

domain güncellemesini uygula:
sudo ldapmodify -Y EXTERNAL -H ldapi:/// -f /root/setdomainname.ldif

OU oluşturma şablonu:
sudo nano /root/adddomain.ldif

dn: dc=hermes,dc=local
objectClass: top
objectClass: dcObject
objectclass: organization
o: My example Organisation
dc: hermes

dn: cn=Manager,dc=hermes,dc=local
objectClass: organizationalRole
cn: Manager
description: OpenLDAP Manager

dn: ou=People,dc=hermes,dc=local
objectClass: organizationalUnit
ou: People

dn: ou=Group,dc=hermes,dc=local
objectClass: organizationalUnit
ou: Group

dosyayı kaydet.

OU oluşturma komutu:
sudo ldapadd -x -D cn=Manager,dc=hermes,dc=local -W -f /root/adddomain.ldif
şifre isticek. oluşturduğumuz şifreyi kullan.

kerem ve abdullah isimli 2 test user oluşturma şablonu:
daha sonra kerem'e sudo vericez. abdullah normal user olcak.
sudo nano /root/kerem.ldif

dn: uid=kerem,ou=People,dc=hermes,dc=local
objectClass: inetOrgPerson
objectClass: posixAccount
objectClass: shadowAccount
cn: kerem
sn: temp
userPassword: {SSHA}2jEeYRSHerfUNztuwVDHnQtDSKrMKrXz
loginShell: /bin/bash
uidNumber: 2000
gidNumber: 2000
homeDirectory: /home/kerem
shadowLastChange: 0
shadowMax: 0
shadowWarning: 0

dn: cn=kerem,ou=Group,dc=hermes,dc=local
objectClass: posixGroup
cn: kerem
gidNumber: 2000
memberUid: kerem

dosyayı kaydet

sudo nano /root/abdullah.ldif

dn: uid=abdullah,ou=People,dc=hermes,dc=local
objectClass: inetOrgPerson
objectClass: posixAccount
objectClass: shadowAccount
cn: abdullah
sn: temp
userPassword: {SSHA}2jEeYRSHerfUNztuwVDHnQtDSKrMKrXz
loginShell: /bin/bash
uidNumber: 2001
gidNumber: 2001
homeDirectory: /home/abdullah
shadowLastChange: 0
shadowMax: 0
shadowWarning: 0

dn: cn=abdullah,ou=Group,dc=hermes,dc=local
objectClass: posixGroup
cn: abdullah
gidNumber: 2001
memberUid: abdullah

dosyayı kaydet.

kullanıcıları oluşturalım:
sudo ldapadd -x -D cn=Manager,dc=hermes,dc=local -W -f /root/kerem.ldif
sudo ldapadd -x -D cn=Manager,dc=hermes,dc=local -W -f /root/abdullah.ldif

kullanıcılar oluştu mu listeleyelim:
ldapsearch -x cn=kerem -b dc=hermes,dc=local
ldapsearch -x cn=abdullah -b dc=hermes,dc=local

!! opsiyonel!! test kullanıcılarını silme:
sudo ldapdelete -x -W -D 'cn=Manager,dc=hermes,dc=local' "uid=kerem,ou=People,dc=hermes,dc=local"
sudo ldapdelete -x -W -D 'cn=Manager,dc=computingforgeeks,dc=com' "cn=kerem,ou=Group,dc=hermes,dc=local"
sudo ldapdelete -x -W -D 'cn=Manager,dc=hermes,dc=local' "uid=abdullah,ou=People,dc=hermes,dc=local"
sudo ldapdelete -x -W -D 'cn=Manager,dc=computingforgeeks,dc=com' "cn=abdullah,ou=Group,dc=hermes,dc=local" 

OpenLDAP SSL/TLS ayarlamaları - sertifika oluşturalım:
sudo openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout /etc/pki/tls/ldapserver.key -out /etc/pki/tls/ldapserver.crt

sahiplik ayarlari:
sudo chown ldap:ldap /etc/pki/tls/{ldapserver.crt,ldapserver.key}

openldap için config şeması oluşturalım:
sudo nano /root/add-tls.ldif

dn: cn=config
changetype: modify
add: olcTLSCACertificateFile
olcTLSCACertificateFile: /etc/pki/tls/ldapserver.crt
-
add: olcTLSCertificateKeyFile
olcTLSCertificateKeyFile: /etc/pki/tls/ldapserver.key
-
add: olcTLSCertificateFile
olcTLSCertificateFile: /etc/pki/tls/ldapserver.crt

dosyayı kaydet.

config şemasını uygulayalım:
sudo ldapadd -Y EXTERNAL -H ldapi:/// -f /root/add-tls.ldif

openldap config'i güncelleyelim:
sudo nano /etc/openldap/ldap.conf

TLS_CACERT     /etc/pki/tls/ldapserver.crt

dosyayı kaydet.

openldap servisini yeniden başlatalım:
sudo systemctl restart slapd

==== ŞİMDİ LDAP KULLANICILARINA SUDO YETKİSİ VERME ====

dosyayı bi görelim:
cat /etc/openldap/schema/sudo.ldif

sudo ekleme şablonu:
sudo nano /root/sudoers.ldif

dn: ou=sudo,dc=hermes,dc=local
objectClass: organizationalUnit
objectClass: top
ou: sudo
description: my-demo LDAP SUDO Entry

dosyayı kaydet.

şemayı sisteme ekleyelim:
sudo ldapadd -x -D cn=Manager,dc=hermes,dc=local -W -f /root/sudoers.ldif

sudo default ayarlarını ayarlamaya devam edelim:
sudo nano /root/sudo-defaults.ldif

dn: cn=defaults,ou=sudo,dc=hermes,dc=local
objectClass: sudoRole
objectClass: top
cn: defaults
sudoOption: env_reset
sudoOption: mail_badpass
sudoOption: secure_path=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/snap/bin
#sudoOrder: 1

dosyayı kaydet.

sudo default'ları sisteme yükleyelim:
sudo ldapadd -x -D cn=Manager,dc=hermes,dc=local -W -f /root/sudo-defaults.ldif

kerem kullanıcısına sudo yetkisi verme şablonu oluşturalım:
sudo nano /root/sudo-kerem.ldif

dn: cn=kerem,ou=sudo,dc=hermes,dc=local
objectClass: sudoRole
objectClass: top
cn: kerem
sudoCommand: ALL
sudoHost: ALL
sudoRunAsUser: ALL
sudoUser: kerem
#sudoOrder: 2

dosyayı kaydet.

kerem'e sudo yetkisini verelim:
sudo ldapadd -x -D cn=Manager,dc=hermes,dc=local -W -f /root/sudo-kerem.ldif